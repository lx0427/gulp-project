/**
 * 微信授权登录，该js必须放在 _foot.html之后
 */
function oauth2(callback){if(!isWeixinBrowse())return void eval(callback+"()");var code=$("#code").val();if(isNull(code))return void eval(callback+"()");var flag=sessionStorage.getItem(code);if(!isNull(flag)&&"1"===flag)return void parseState(callback);var url=cloudPath+"/weixin/oauth2.do",dataMap={};dataMap.code=code,dataMap.state=$("#state").val();var redirectUri=$("#redirectUri").val();isNull(redirectUri)&&(redirectUri=location.href,redirectUri.indexOf("?")!==-1&&(redirectUri=redirectUri.split("?")[0])),redirectUri=redirectUri.replace("/android/","/wx/").replace("/ios/","/wx/"),dataMap.redirectUri=redirectUri,$.ajaxjsonp(url,dataMap,function(data){var d=eval(data);if(!isNull(d.wxurl))return openPage("授权",d.wxurl,"1"),!1;sessionStorage.setItem(code,"1"),setLocalData("tokenId",d.tokenId);var obj=d.state;if(!isNull(obj)){var appendHtml="";for(var p in obj)0===$("#"+p).length?appendHtml+="<input type='hidden' id='"+p+"' value='"+obj[p]+"' />":($("#"+p).val(obj[p]),$("#"+p).attr("gdval",obj[p]));isNull(appendHtml)||$("body").append(appendHtml)}eval(callback+"()")})}function parseState(callback){var state=$("#state").val();if(isNull(state))eval(callback+"()");else{var url=cloudPath+"/weixin/parseState.do",dataMap={};dataMap.state=state,$.ajaxjsonp(url,dataMap,function(data){var d=eval(data),obj=d.state;if(!isNull(obj)){var appendHtml="";for(var p in obj)0===$("#"+p).length?appendHtml+="<input type='hidden' id='"+p+"' value='"+obj[p]+"' />":($("#"+p).val(obj[p]),$("#"+p).attr("gdval",obj[p]));isNull(appendHtml)||$("body").append(appendHtml)}eval(callback+"()")})}}function getOauthOpenid(callback){if(!isWeixinBrowse())return void eval(callback+"()");var code=$("#code").val();if(isNull(code))return void eval(callback+"()");var flag=sessionStorage.getItem(code);if(!isNull(flag)&&"1"===flag)return void parseOauthState(callback);("undefined"==typeof oauthServerSuffix||isNull(oauthServerSuffix))&&(oauthServerSuffix=".htm");var url=oauthServerPath+"/weixin/jsapi/getOauthOpenid"+oauthServerSuffix,dataMap={};dataMap.code=code,dataMap.state=$("#state").val();var redirectUri=$("#redirectUri").val();isNull(redirectUri)&&(redirectUri=location.href,redirectUri.indexOf("?")!==-1&&(redirectUri=redirectUri.split("?")[0])),redirectUri=redirectUri.replace("/android/","/wx/").replace("/ios/","/wx/"),dataMap.redirectUri=redirectUri,$.ajaxjsonp(url,dataMap,function(data){var d=eval(data);if(!isNull(d.wxurl))return openPage("授权",d.wxurl,"1"),!1;sessionStorage.setItem("getOauthOpenidFlag","1");var obj=d.state;if(!isNull(obj)){var appendHtml="";for(var p in obj)"appid"==p&&sessionStorage.setItem("wxAppid",obj[p]),0===$("#"+p).length?appendHtml+="<input type='hidden' id='"+p+"' value='"+obj[p]+"' />":($("#"+p).val(obj[p]),$("#"+p).attr("gdval",obj[p]));isNull(appendHtml)||$("body").append(appendHtml)}var openid=d.openid;isNull(openid)||(sessionStorage.setItem("wxOpenid",openid),0===$("#openid").length?$("body").append("<input type='hidden' id='openid' value='"+openid+"' />"):$("#openid").val(openid)),eval(callback+"()")})}function parseOauthState(callback){var state=$("#state").val();if(isNull(state))eval(callback+"()");else{("undefined"==typeof oauthServerSuffix||isNull(oauthServerSuffix))&&(oauthServerSuffix=".htm");var url=oauthServerPath+"/weixin/jsapi/parseState"+oauthServerSuffix,dataMap={};dataMap.state=state,$.ajaxjsonp(url,dataMap,function(data){var d=eval(data),obj=d.state;if(!isNull(obj)){var appendHtml="";for(var p in obj)0===$("#"+p).length?appendHtml+="<input type='hidden' id='"+p+"' value='"+obj[p]+"' />":($("#"+p).val(obj[p]),$("#"+p).attr("gdval",obj[p]));isNull(appendHtml)||$("body").append(appendHtml)}eval(callback+"()")})}}